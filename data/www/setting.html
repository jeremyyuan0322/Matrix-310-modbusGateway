<!DOCTYPE html>
<html>

<head>
  <title>Modbus Gateway</title>
  <link rel="stylesheet" type="text/css" href="/css/w3.css" />
  <!-- <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/w3-css/4.1.0/w3.css" /> -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* 默認情況下為橫向導航欄 */
    .w3-bar {
      display: flex;
      flex-direction: row;
      justify-content: flex-start;
    }

    .flex-container {
      display: flex !important;
      justify-content: space-between !important;
    }

    .modal-content {
      width: 300px;
      margin: auto;
      padding: 50px 0;
      display: flex;
      /* 使用flexbox讓內部元素可以自動排列並居中 */
      justify-content: center;
      /* 水平居中內部元素 */
      align-items: center;
      /* 垂直居中內部元素 */
    }

    .change-password-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .changePwd {
      width: 90%;
    }

    input{
      max-width: 194px;
      max-height: 30px;
      padding: 0px 0px 0px 5px;
    }
    .eye-flex {
      display: flex;
      width: 194px;
      height: 30px;
      border: 1px solid #797979;
      border-radius: 2px;
      padding: 0px;
      margin-bottom: 23px;
      display: flex;
      align-items: center;
    }
    .eye-flex input {
      border: none;
      outline: none;
      margin: 0px 0px 0px 5px;
      padding: 0px;
      width: 162px;
    }
    img.eye {
      height: 15px;
      width: 15px;
      cursor: pointer;
    }

    .changePwd {
      max-width: 241.19px
    }

    img.change-pwd-eye {
      height: 15px;
      width: 15px;
      position: relative;
      right: 30px;
      bottom: 3px;
      cursor: pointer;
    }

    img.logout {
      /* height: 20px; */
      width: 25px;
    }

    img.hint{
      position: relative;
      height: 17px;
    }

    /* 螢幕寬度小於 600px */
    @media screen and (max-width: 576px) {
      .w3-bar {
        flex-direction: column;
      }

      .logo {
        height: auto;
        /* You can adjust this to fit your design */
        width: 120px;
        /* This will keep the aspect ratio of your logo */
      }

      .modal-content {
        margin-top: 50px;
        /* 調整彈窗往下的距離 */
        width: 300px;
        /* 設定彈窗的寬度 */
        margin-left: auto;
        /* 水平居中設定 */
        margin-right: auto;
        /* 水平居中設定 */
      }
    }

    @media screen and (min-width: 576px) {
      .w3-table-all {
        position: relative;
        /* padding-top: 100px; */
        /* padding-bottom: 30px; */
        align-items: baseline;
        width: 60%;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -0%);
      }

      .logout-container {
        display: flex;
        justify-content: flex-end !important;
        /* padding: 12px !important; */
        /* margin: 10px !important; */
        position: fixed;
        right: 0;
        top: 0;
        height: 50px;
        width: 100%;
      }

      .logo {
        height: 50px;
        padding: 4px 8px;
      }

      .w3-bar {
        height: 50px;
      }

    }
  </style>
  <script>
    // has session storage or not
    if (!sessionStorage.getItem('isLogin')) {
      // redirect to login page
      window.location.href = "/index.html";
      alert('Please login first.');
    }
  </script>
</head>

<body>
  <!-- 分頁選項 -->
  <div class="w3-bar w3-black">
    <a href="#" onclick="openTab('networkTab')">
      <img class="logo" src="/img/artila_logo.png" alt="Artila">
    </a>
    <button class="w3-bar-item w3-button" onclick="openTab('networkTab')">
      Network Setting
    </button>
    <button class="w3-bar-item w3-button" onclick="openTab('serialTab')">
      Serial Setting
    </button>
    <button class="w3-bar-item w3-button" onclick="openTab('modbusTab')">
      Modbus Gateway Setting
    </button>
    <!--
    <button class="w3-bar-item w3-button" onclick="openTab('csvTab')">
      CSV Upload
    </button>
    -->
    <button class="w3-bar-item w3-button" onclick="openTab('systemTab')">
      System Information
    </button>
    <button class="w3-bar-item w3-button" id="rebootBtn">Reboot</button>
    <button class="w3-bar-item w3-button logout-container" id="logoutBtn">
      <img src="/img/logout.svg" alt="Logout" class="logout" />
      Logout
    </button>
  </div>

  <div id="networkTab" class="w3-container w3-margin tab">
    <div>
      <h2>Network Setting</h2>
      <select name="netInterface" onchange="switchInterface(this.value)">
        <option value="0" selected>Wi-Fi</option>
        <option value="1">Ethernet</option>
      </select><br>
    </div>

    <!-- Existing Wi-Fi settings table -->
    <div id="wifiBlock" style="display: none;">
      <h2>Wi-Fi Setting</h2>
      <!-- Existing form fields go here -->
      <form id="wifiForm">
        <!-- Existing form fields go here -->
        <label for="wifiMode">WiFi Mode:</label><br>
        <select name="wifiMode" onchange="showWifiStatic(this.value)">
          <option value="0" selected>DHCP</option>
          <option value="1">Manual</option>
        </select><br>
        <label for="ssid">SSID:</label><br>
        <input type="text" name="ssid" pattern="^[^,]*$" maxlength="20"><br>
        <label for="staPwd">Password:</label><br>
        <div class="eye-flex">
          <input type="password" name="staPwd" id="staPwd" pattern="^[^,]*$" maxlength="20"><br>
          <img src="/img/eye.svg" alt="show/hide" class="eye" onclick="togglePwdVisible('staPwd')"/>
        </div>
        <div id="wifiStatic">
          <label for="wifiIp">IPv4 Address:</label><br>
          <input type="text" name="wifiIp" value="192.168.2.127"><br>
          <label for="wifiNetmask">Subnet Mask:</label><br>
          <input type="text" name="wifiNetmask" value="255.255.255.0"><br>
          <label for="wifiGateway">Gateway:</label><br>
          <input type="text" name="wifiGateway" value="192.168.2.1"><br><br>
        </div>
        <button type="submit">Save</button>
      </form>
    </div>

    <!-- New Ethernet settings table -->
    <div id="ethBlock" style="display: none;">
      <h2>Ethernet Setting</h2>
      <!-- Existing form fields go here -->
      <form id="ethForm">
        <label for="ethMode">Ethernet Mode:</label><br>
        <select name="ethMode" onchange="showEthStatic(this.value)">
          <option value="0">DHCP</option>
          <option value="1" selected>Manual</option>
        </select><br>
        <div id="ethStatic">
          <label for="ethIp">IPv4 Address:</label><br>
          <input type="text" name="ethIp" value="192.168.2.127"><br>
          <label for="ethNetmask">Subnet Mask:</label><br>
          <input type="text" name="ethNetmask" value="255.255.255.0"><br>
          <label for="ethGateway">Gateway:</label><br>
          <input type="text" name="ethGateway" value="192.168.2.1"><br>
        </div><br>
        <button type="submit">Save</button>
      </form>
    </div>
  </div>

  <!-- 串口設定 -->
  <div id="serialTab" class="w3-container w3-margin tab" style="display: none">
    <h2>Serial Setting</h2>
    <!-- 表單內容 -->
    <div>
      <form id="serialForm">
        <label for="baud">Baud:</label><br>
        <select name="baud">
          <option value="2400">2400</option>
          <option value="4800">4800</option>
          <option value="7200">7200</option>
          <option value="9600" selected>9600</option>
          <option value="19200">19200</option>
          <option value="38400">38400</option>
          <option value="57600">57600</option>
          <option value="115200">115200</option>
          <option value="230400">230400</option>
          <option value="460800">460800</option>
          <option value="921600">921600</option>
        </select><br>
        <label for="parityBit">Parity Bit:</label><br>
        <select name="parityBit">
          <option value="0" selected>None</option>
          <option value="1">Odd</option>
          <option value="2">Even</option>
        </select><br>
        <label for="dataBit">Data Bit:</label><br>
        <select name="dataBit">
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8" selected>8</option>
        </select><br>
        <label for="stopBit">Stop Bit:</label><br>
        <select name="stopBit">
          <option value="1" selected>1</option>
          <option value="2">2</option>
        </select><br>
        <label for="rtuTimeout">RTU Timeout(ms):</label><br>
        <input type="number" name="rtuTimeout" min="1" max="4294967295" value="3000" required><br><br>
        <button type="submit">Save</button>
      </form>
    </div>
  </div>

  <!-- Modbus Gateway設定 -->
  <div id="modbusTab" class="w3-container w3-margin tab" style="display: none">
    <h2>Modbus Gateway Setting</h2>
    <!-- 表單內容 -->
    <div>
      <form id="mbBridge">
        <label for="port">Port:</label><br>
        <input type="number" name="port" min="1" max="65535" value="502" required><br>
        <label for="uidMin">UID Min:</label><br>
        <input type="number" name="uidMin" min="1" max="247" value="1" oninput="adjustMax()" required><br>
        <label for="uidMax">UID Max:</label><br>
        <input type="number" name="uidMax" min="1" max="247" value="16" oninput="adjustMax()" required><br>
        <label for="tcpTimeout">TCP Client Timeout(ms):</label><br>
        <input type="number" name="tcpTimeout" min="0" max="4294967295" value="0" placeholder="0 means never timeout" style="width: 200px;" required><br><br>
        <button type="submit">Save</button>
      </form>
    </div>
  </div>
  <!--
  // CSV上傳
  <div id="csvTab" class="w3-container w3-margin tab" style="display: none">
    <h2>CSV Upload</h2>
    // 表單內容
    <div>
      <form id="csvForm" enctype="multipart/form-data">
        <input type="file" name="csvFile" accept=".csv">
        <button type="submit">Upload</button>
      </form>
      <a id="downloadButton" href="#" download="settings.csv">Download Current Setting</a>
    </div>
  </div>
-->
  <div id="systemTab" class="w3-container w3-margin tab" style="display: none">
    <table class="w3-table-all">
      <thead>
        <tr>
          <th colspan="2" class="w3-black">
            <h5>System Information</h5>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>User name</td>
          <td class="flex-container">
            <span id="tUserName"></span>
            <button id="changePasswordButton" onclick="document.getElementById('passwordModal').style.display='block'">Change Password</button>
          </td>
        </tr>
        <tr>
          <td>Device name</td>
          <td id="tDeviceName"></td>
        </tr>
        <tr>
          <td>Software version</td>
          <td id="tSwVersion"></td>
        </tr>
        <tr>
          <td>WiFi Station Mac Address</td>
          <td id="tWifiStaMac"></td>
        </tr>
        <tr>
          <td>WiFi AP Mac Address</td>
          <td id="tWifiApMac"></td>
        </tr>
        <tr>
          <td>Ethernet Mac Address</td>
          <td id="tEthMac"></td>
        </tr>
        <tr>
          <td>Current Network Interface</td>
          <td id="tNetInterface"></td>
        </tr>
        <!-- tWifi -->
        <tr class="tWifi tWifiDhcp">
          <td>Current Network Mode</td>
          <td id="tWifiMode"></td>
        </tr>
        <tr class="tWifi tWifiDhcp">
          <td>SSID</td>
          <td id="tSsid"></td>
        </tr>
        <tr class="tWifi tWifiDhcp">
          <td>IPv4 Address</td>
          <td id="tWifiIp"></td>
        </tr>
        <!-- tWifiStatic -->
        <tr class="tWifi tWifiStatic">
          <td>Subnet Mask</td>
          <td id="tWifiNetmask"></td>
        </tr>
        <tr class="tWifi tWifiStatic">
          <td>Gateway</td>
          <td id="tWifiGateway"></td>
        </tr>
        <!-- tEth -->
        <tr class="tEth tEthDhcp">
          <td>Current Network Mode</td>
          <td id="tEthMode"></td>
        </tr>
        <tr class="tEth tEthDhcp">
          <td>IPv4 Address</td>
          <td id="tEthIp"></td>
        </tr>
        <!-- tEthStatic -->
        <tr class="tEth tEthStatic">
          <td>Subnet Mask</td>
          <td id="tEthNetmask"></td>
        </tr>
        <tr class="tEth tEthStatic">
          <td>Gateway</td>
          <td id="tEthGateway"></td>
        </tr>
      </tbody>
    </table>
    <div id="passwordModal" class="w3-modal">
      <div class="w3-modal-content modal-content">
        <div class="w3-container">
          <span class="w3-button w3-display-topright">&times;</span>
          <h3>Change Password</h3>
          <p>Password should be 8-20 characters long, and can only contain alphanumeric characters, no special symbols
            allowed.</p>
          <form id="changePasswordForm" class="change-password-form">
            <div style="position: relative;">
              <input type="password" name="currentPassword" id="currentPassword" class="changePwd"
                placeholder="Current Password" pattern="^[A-Za-z0-9]{8,20}$" required>
              <img src="/img/eye.svg" alt="show/hide" class="change-pwd-eye"
                onclick="togglePwdVisible('currentPassword')" />
            </div>
            <div>
              <input type="password" name="newPassword" id="newPassword" class="changePwd" placeholder="New Password"
                pattern="^[A-Za-z0-9]{8,20}$" required>
              <img src="/img/eye.svg" alt="show/hide" class="change-pwd-eye"
                onclick="togglePwdVisible('newPassword')" />
            </div>
            <div>
              <input type="password" name="confirmPassword" id="confirmPassword" class="changePwd"
                placeholder="Confirm New Password" pattern="^[A-Za-z0-9]{8,20}$" required>
              <img src="/img/eye.svg" alt="show/hide" class="change-pwd-eye"
                onclick="togglePwdVisible('confirmPassword')" />
            </div>
            <span id="changePwdFail" style="color: red;"></span>
            <button class="w3-button w3-black" type="submit" style="width: 90%;">Change Password</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    "use strict";
    let isFormChanged = false; // To check if form is changed but not saved yet
    // javascript function to open tabs
    function openTab(tabName) {
      let isConfirmed = false;
      if (isFormChanged) {
        isConfirmed = confirm('Not saved yet, are you sure you want to switch pages?');
        if (!isConfirmed) {
          return;
        }
      }
      isFormChanged = false;
      if (isConfirmed) {
        fetchSettings();
      }
      let i;
      let x = document.getElementsByClassName("tab");
      for (i = 0; i < x.length; i++) {
        x[i].style.display = "none";
      }
      document.getElementById(tabName).style.display = "block";
    }

    // Add an input event listener to each form
    document.querySelectorAll('form').forEach(form => {
      form.addEventListener('input', () => {
        isFormChanged = true;
      });

      // Reset the flag after the form is submitted
      form.addEventListener('submit', () => {
        isFormChanged = false;
      });
    });

    // wifiForm submission handler
    document.getElementById('wifiForm').addEventListener('submit', async function (event) {
      event.preventDefault();
      let form = event.target;
      let formData = new FormData(form);
      let data = Object.fromEntries(formData.entries());
      await sendFormData('/wifi', data);
    });

    // ethForm submission handler
    document.getElementById('ethForm').addEventListener('submit', async function (event) {
      event.preventDefault();
      let form = event.target;
      let formData = new FormData(form);
      let data = Object.fromEntries(formData.entries());
      await sendFormData('/eth', data);
    });

    function switchInterface(value) {
      let wifiBlock = document.getElementById('wifiBlock');
      let ethBlock = document.getElementById('ethBlock');
      // 0: wifi, 1: eth
      if (value === "0") {
        ethBlock.style.display = "none";
        wifiBlock.style.display = "block";
        let wifiMode = document.querySelector('select[name="wifiMode"]').value;
        showWifiStatic(wifiMode);
        // document.querySelector('select[name="wifiMode"]').value = "0";
      } else {
        wifiBlock.style.display = "none";
        ethBlock.style.display = "block";
        let ethMode = document.querySelector('select[name="ethMode"]').value;
        showEthStatic(ethMode);
        // document.querySelector('select[name="ethMode"]').value = "1";
      }
      isFormChanged = true; // netInterface is not in form, so manually set the flag
    }

    function showWifiStatic(value) {
      let pattern = value === "1" ? "^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$" : "";
      let wifiStatic = document.getElementById('wifiStatic');
      // 0: dhcp, 1: static
      if (value === "1") {
        wifiStatic.style.display = 'block';
        document.querySelector('input[name="wifiIp"]').pattern = pattern;
        document.querySelector('input[name="wifiNetmask"]').pattern = pattern;
        document.querySelector('input[name="wifiGateway"]').pattern = pattern;
      } else {
        wifiStatic.style.display = 'none';
      }
    }

    function showEthStatic(value) {
      let pattern = value === "1" ? "^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$" : "";
      let ethStatic = document.getElementById('ethStatic');
      // 0: dhcp, 1: static
      if (value === "1") {
        ethStatic.style.display = 'block';
        document.querySelector('input[name="ethIp"]').pattern = pattern;
        document.querySelector('input[name="ethNetmask"]').pattern = pattern;
        document.querySelector('input[name="ethGateway"]').pattern = pattern;
      } else {
        ethStatic.style.display = 'none';
      }
    }

    function togglePwdVisible(inputId) {
      let passwordInput = document.getElementById(inputId);
      if (passwordInput.type === "password") {
        passwordInput.type = "text";
      } else {
        passwordInput.type = "password";
      }
    }

    // serialForm submission handler
    document.getElementById('serialForm').addEventListener('submit', async function (event) {
      event.preventDefault();
      let form = event.target;
      let formData = new FormData(form);
      let data = Object.fromEntries(formData.entries());
      await sendFormData('/serial', data);
    });

    // Modbus Gateway Setting Form Submission
    document.getElementById('mbBridge').addEventListener('submit', async function (event) {
      event.preventDefault();
      let form = event.target;
      let formData = new FormData(form);
      let data = Object.fromEntries(formData.entries());
      await sendFormData('/bridge', data);
    });

    document.getElementById('changePasswordForm').addEventListener('submit', async function (event) {
      event.preventDefault();
      let form = event.target;
      let formData = new FormData(form);
      let data = Object.fromEntries(formData.entries());
      if (data.currentPassword === data.newPassword) {
        document.getElementById("changePwdFail").innerText = "New Password cannot be the same as Current Password!";
        return;
      }
      else if (data.newPassword !== data.confirmPassword) {
        document.getElementById("changePwdFail").innerText = "New Password and Confirm Password do not match!";
        return;
      }
      await sendFormData('/changePassword', data);
    });
    
    // close change password modal and clear the form
    document.querySelector('.w3-display-topright').addEventListener('click', function() {
      document.getElementById('passwordModal').style.display = 'none';
      isFormChanged = false;
      // Clear all input fields in the form
      let form = document.querySelector('#passwordModal form');
      for (let i = 0; i < form.elements.length; i++) {
        if (form.elements[i].type === 'text' || form.elements[i].type === 'password') {
          form.elements[i].value = '';
        }
      }
    });

    function adjustMax() {
    let uidMinInput = document.querySelector('input[name="uidMin"]');
    let uidMaxInput = document.querySelector('input[name="uidMax"]');
    
    let uidMin = parseInt(uidMinInput.value);
    let uidMax = parseInt(uidMaxInput.value);

    // Ensure uidMax is always >= uidMin
    uidMaxInput.min = uidMin;

    // Ensure uidMax - uidMin <= 16
    uidMaxInput.max = uidMin + 15;

    // Ensure uidMax is always <= 247
    if (uidMaxInput.max > 247) {
        uidMaxInput.max = 247;
    }
    // console.log(uidMaxInput.min, uidMaxInput.max);
  }


    // CSV Upload Form Submission
    // const csvForm = document.querySelector("#csvForm");
    // csvForm.addEventListener("submit", function (event) {
    //   event.preventDefault();
    //   var csvFile = document.querySelector('input[name="csvFile"]').files[0];
    //   var formData = new FormData();
    //   formData.append("csvFile", csvFile);
    //   sendFileData("/upload", formData);
    // });

    // window.addEventListener('DOMContentLoaded', (event) => {
    //   // set the download link to the path of the settings file on the ESP32 server
    //   document.querySelector("#downloadButton").href = "/download";
    // });

    window.onload = function () {
      fetchSettings();
      fetchSystemInfo();
    };

    async function fetchSettings() {
      try {
        // fetch settings from the ESP32 server
        let response = await fetch('/getSetting');
        let settings = await response.text();

        if (settings === "") {
          alert("No settings found on the ESP32 server");
          return;
        }
        let settingsArray = settings.split(',');
        //userName,userPwd,deviceName,netInterface,wifiSetFin,ssid,staPwd,wifiMode,wifiIp,wifiNetmask,wifiGateway,ethSetFin,ethMode,ethIp,ethNetmask,ethGateway,serialSetFin,baud,parityBit,dataBit,stopBit,rtuTimeout,bridgeSetFin,port,uidMin,uidMax,tcpTimeout
        // for(let i = 0; i < settingsArray.length; i++) {
        //   console.log(i);
        //   console.log(settingsArray[i]);
        // }
        // update settings
        let netInterface = document.querySelector('select[name="netInterface"]');
        let wifiMode = document.querySelector('select[name="wifiMode"]');
        let ethMode = document.querySelector('select[name="ethMode"]');
        document.getElementById('tUserName').innerText = settingsArray[0];
        document.getElementById('tDeviceName').innerText = settingsArray[2];
        netInterface.value = settingsArray[3];
        document.querySelector('input[name="ssid"]').value = settingsArray[5];
        document.getElementById('tSsid').innerText = settingsArray[5];
        document.querySelector('input[name="staPwd"]').value = settingsArray[6];
        wifiMode.value = settingsArray[7];
        document.querySelector('input[name="wifiIp"]').value = settingsArray[8];
        document.getElementById('tWifiIp').innerText = settingsArray[8];
        document.querySelector('input[name="wifiNetmask"]').value = settingsArray[9];
        document.getElementById('tWifiNetmask').innerText = settingsArray[9];
        document.querySelector('input[name="wifiGateway"]').value = settingsArray[10];
        document.getElementById('tWifiGateway').innerText = settingsArray[10];
        ethMode.value = settingsArray[12];
        document.querySelector('input[name="ethIp"]').value = settingsArray[13];
        document.getElementById('tEthIp').innerText = settingsArray[13];
        document.querySelector('input[name="ethNetmask"]').value = settingsArray[14];
        document.getElementById('tEthNetmask').innerText = settingsArray[14];
        document.querySelector('input[name="ethGateway"]').value = settingsArray[15];
        document.getElementById('tEthGateway').innerText = settingsArray[15];
        document.querySelector('select[name="baud"]').value = settingsArray[17];
        document.querySelector('select[name="parityBit"]').value = settingsArray[18];
        document.querySelector('select[name="dataBit"]').value = settingsArray[19];
        document.querySelector('select[name="stopBit"]').value = settingsArray[20];
        document.querySelector('input[name="rtuTimeout"]').value = settingsArray[21];
        document.querySelector('input[name="port"]').value = settingsArray[23];
        document.querySelector('input[name="uidMin"]').value = settingsArray[24];
        document.querySelector('input[name="uidMax"]').value = settingsArray[25];
        document.querySelector('input[name="tcpTimeout"]').value = settingsArray[26];
        switchInterface(netInterface.value);
        showWifiStatic(wifiMode.value);
        showEthStatic(ethMode.value);
        isFormChanged = false; // switchInterface() will set isFormChanged to true
      } catch (error) {
        console.error('Error:', error);
      }
    }

    async function fetchSystemInfo() {
      try {
        // fetch settings from the ESP32 server
        let response = await fetch('/getSystemInfo');
        let systemInfo = await response.text();

        if (systemInfo === "") {
          alert("No SystemInfo found on the ESP32 server");
          return;
        }
        let InfoArray = systemInfo.split(',');
        // software version, wifiStaMac, wifiApMac, ethMac, currentNetInterface, dhcpIp
        // [currentNetInterface]
        // WIFI_DHCP = 0,
        // WIFI_STATIC = 1,
        // ETHERNET_DHCP = 2,
        // ETHERNET_STATIC = 3,
        // NO_NETWORK = 4
        // v1.0.0,98:F4:AB:17:24:9C,98:F4:AB:17:24:9D,98:f4:ab:17:27:9e,4
        console.log(InfoArray[4]);
        document.getElementById('tSwVersion').innerText = InfoArray[0];
        document.getElementById('tWifiStaMac').innerText = InfoArray[1];
        document.getElementById('tWifiApMac').innerText = InfoArray[2];
        document.getElementById('tEthMac').innerText = InfoArray[3];
        let tNetInterface = document.getElementById('tNetInterface');
        let tWifiMode = document.getElementById('tWifiMode');
        let tWifiIp = document.getElementById('tWifiIp');
        let tEthMode = document.getElementById('tEthMode');
        let tEthIp = document.getElementById('tEthIp');
        let tWifi = document.querySelectorAll('.tWifi');
        let tWifiStatic = document.querySelectorAll('.tWifiStatic');
        let tEth = document.querySelectorAll('.tEth');
        let tEthStatic = document.querySelectorAll('.tEthStatic');
        switch (InfoArray[4]) {
          case '0':
            tNetInterface.innerText = "WiFi";
            tWifiMode.innerText = "DHCP";
            console.log("wifi dhcp");
            console.log(InfoArray[5]);
            tWifiIp.innerText = InfoArray[5];
            console.log(tWifiStatic.length);
            console.log(tEth.length);
            for (let i = 0; i < tWifiStatic.length; i++) {
              tWifiStatic[i].style.display = "none";
            }
            for (let i = 0; i < tEth.length; i++) {
              tEth[i].style.display = "none";
            }
            break;
          case '1':
            tNetInterface.innerText = "WiFi";
            tWifiMode.innerText = "Static";
            for (let i = 0; i < tEth.length; i++) {
              tEth[i].style.display = "none";
            }
            break;
          case '2':
            tNetInterface.innerText = "Ethernet";
            tEthMode.innerText = "DHCP";
            console.log("eth dhcp");
            console.log(InfoArray[5]);
            tEthIp.innerText = InfoArray[5];
            for (let i = 0; i < tWifi.length; i++) {
              tWifi[i].style.display = "none";
            }
            for (let i = 0; i < tEthStatic.length; i++) {
              tEthStatic[i].style.display = "none";
            }
            break;
          case '3':
            tNetInterface.innerText = "Ethernet";
            tEthMode.innerText = "Static";
            for (let i = 0; i < tWifi.length; i++) {
              tWifi[i].style.display = "none";
            }
            break;
          default:
            tNetInterface.innerText = "No Network";
            for (let i = 0; i < tWifi.length; i++) {
              tWifi[i].style.display = "none";
            }
            for (let i = 0; i < tEth.length; i++) {
              tEth[i].style.display = "none";
            }
            break;
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

    async function autoRefresh() {
      let timeout = 50000;
      try {
          let response = await fetch(window.location.href);
          if (response.status !== 200) {
              // 如果響應碼不是200，再次設置10秒的延遲並重複檢查
              console.log("response status: " + response.status + ", retrying in 10 seconds")
              setTimeout(autoRefresh, timeout);
          } else {
              // 如果響應碼是200，刷新頁面
              console.log("Server is ready");
              location.reload();
          }
      } catch (error) {
          console.error('Error:', error);
          // 如果發生錯誤，也再次設置10秒的延遲並重複檢查
          setTimeout(autoRefresh, timeout);
      }
    }
    
    document.getElementById("rebootBtn").onclick = function () {
      let isConfirmed = false;
      let timeout = 13000;
      if (isFormChanged) {
        isConfirmed = confirm('You have not saved your settings, are you sure you want to reboot?');
        if (!isConfirmed) {
          return;
        }
      }
      isFormChanged = false;
      if (isConfirmed) {
        setTimeout(autoRefresh, 13000);
        fetch("/reboot");
        alert("Reboot now!\nPlease wait for 10 seconds to reconnect.");
      }
      else{
        if (confirm("Are you sure you want to reboot?")) {
          setTimeout(autoRefresh, 13000);
          fetch("/reboot");
          alert("Reboot now!\nPlease wait for 10 seconds to reconnect.");
        }
      }
      
    };

    document.getElementById('logoutBtn').addEventListener('click', function () {
      if (confirm("logout now?")) {
        sessionStorage.removeItem('isLogin');
        window.location.href = "/index.html";
      }
    });

    // function sendFormData(url, data) {
    //   var xhr = new XMLHttpRequest();
    //   xhr.onreadystatechange = function () {
    //     if (this.readyState == 4 && this.status == 200) {
    //       var response = xhr.responseText;
    //       alert(response);
    //       window.location.href = "/";
    //     }
    //   };
    //   xhr.open("POST", url, true);
    //   xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    //   var formEncodedData = Object.keys(data).map(function (key) {
    //     return key + '=' + encodeURIComponent(data[key]);
    //   }).join('&');
    //   xhr.send(formEncodedData);
    // }

    async function sendFormData(url, data) {
      let params = new URLSearchParams();

      for (let key in data) {
        params.append(key, data[key]);
      }

      try {
        let response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: params,
        });
        if (response.status === 200) {
          let responseText = await response.text();
          alert(responseText);
        }
        else if (response.status === 403) {
          alert("Forbidden: Incorrect password.");
        }
        else {
          console.log(`Unexpected response status: ${response.status}`);
        }
        // window.location.href = "/";
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // function sendFileData(url, data) {
    //   var xhr = new XMLHttpRequest();
    //   xhr.onreadystatechange = function () {
    //     if (this.readyState == 4 && this.status == 200) {
    //       var response = xhr.responseText;
    //       alert(response);
    //       window.location.href = "/";
    //     }
    //   };
    //   xhr.open("POST", url, true);
    //   xhr.send(data);
    // }

  </script>
</body>

</html>